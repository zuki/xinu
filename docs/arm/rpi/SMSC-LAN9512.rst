SMSC LAN9512
============

このページでは :doc:`Raspberry-Pi` Model Bに内蔵されているEthernetアダプタである
SMSC LAN9512 USB Ethernetアダプタ用のEmbedded Xinu（すなわち、 :doc:`XinuPi` ）の
ドライバを説明します。

ドライバの概要
---------------

ドライバは :source:`device/smsc9512/` に実装されています。

SMSC LAN9512はUSBデバイスなので使用するには :doc:`/features/USB` のサポートが
有効になっている必要があります。

他のOSでは同等のドライバにsmsc95xxなどの名前を付けていますが、これはSMSCが
名前の最後の2桁だけが異なる非常によく似たデバイスを複数製造しているためと
思われます。この文書を書いている時点でこのドライバはSMSC LAN9512でしかテスト
していません。

SMSC LAN9512は実は、USBハブ *と* Ethernetアダプタが統合された製品です。
Ethernetアダプタ自体はこのハブに接続された別デバイスとしてUSB上に現れます。
そして、Raspberry Pi model Bでデバイスを接続することのできるUSBポートは
このハブに接続されている別のポートなのです。幸いなことに、この詳細はUSB
サブシステムによって処理され、ハブにはハブドライバを、Ethernetアダプタ
デバイスにはこのドライバを自動的に使用することになります。

デバイスモデル
--------------

このドライバはRaspberry Pi Model Bのために書かれています。このボードには
SMSC LAN9512が恒久的に取り付けられています。そのためと他のXinuとの互換性の
ために、このドライバはXinuの静的デバイスモデルに準拠しています。したって、
外部のSMSC LAN9512をボードのUSBポートに物理的に接続したり、SMSC LAN9512を
内蔵していないシステムでこのドライバを有効にすることは（まだ）期待できません。
しかし、XinuのUSBサブシステムはすでにデバイスの動的な着脱をサポートしている
ので、必要であれば実装することができるはずです。

MACアドレスの生成
----------------------

あらかじめ決められたMACアドレスを持つためには、使用するSMSC LAN9512が
MACアドレスを格納しているEEPROMに接続されていなければなりません。しかし、Raspberry Pi Model BにはこのEEPROMが存在しないため、このドライバが自ら
MACアドレスを割り当てる必要があります。そのため、このドライバではボードの
シリアル番号からMACアドレスを生成しています。これにより、使用するRaspberry
Piは常に同じMACアドレスを持つことが保証され、2つのRaspberry Piに同じMAC
アドレスが割り当てられる可能性は極めて低くなります。

パケットの送受信
-----------------------------

パケットの送受信はXinuの他のEthernetドライバと同様に ``etherWrite()`` と
``etherRead()`` を呼び出すことで行われます。したがって、このセクションの
残りの部分ではドライバの内部詳細について説明します。

USBイーサネットの極めて標準的なアダプタのように、ネットワークパケットは
USBバルク転送を使用してUSB上でUSBイーサネットアダプタデバイスとの間で
送受信されます。これらの転送には多かれ少なかれデバイス固有のデータとそれに
続く生のパケットデータが含まれます。詳しくはコードをご覧ください。

USBバルク転送の動作の詳細は :doc:`USBサブシステム </features/USB>` にあります。

ハードウェアのドキュメント
---------------------------

私たちの知る限り、このデバイスに関する「プログラマーズ・リファレンス・
マニュアル」などは存在しません。したがって、このドライバを書くためには
SMSCがLinuxに提供したドライバから必要なハードウェアの詳細を得る必要が
ありました。Linuxのドライバでの対応する定義にはドキュメントがないので、
ファイル :source:`device/smsc9512/smsc9512.h` にこのドライバで使用した
レジスタについてドキュメント化を試みています。

未実装の機能
----------------------

- 互換性のあると思われる他のSMSC LAN95XXデバイスのサポート
- デバイスの動的着脱
- 接続されたEEPROMからの読み込み
- VLAN
- TCP/IPチェックサムオフロード
- 一時停止
- Wake-on-LAN
- 様々なPHY機能
